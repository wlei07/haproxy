# Global settings
global
    log stdout format raw local0                  # Log to stdout (Docker-friendly)
    maxconn 2048                           # Maximum number of connections
    daemon                                 # Run in the background
    stats socket /tmp/haproxy.sock mode 600 level admin

# Default settings for all listeners and backends
defaults
    log global                             # Use global log settings
    mode http                              # Default to HTTP mode
    option httplog                         # Enable HTTP logging
    option dontlognull                     # Don't log null connections
    retries 3                              # Retry 3 times before marking a server down
    timeout connect 5s                     # Max time to connect to backend
    timeout client 50s                     # Max inactivity time on the client side
    timeout server 50s                     # Max inactivity time on the server side
    timeout http-request 10s               # Timeout for HTTP requests
    timeout http-keep-alive 10s            # Timeout for HTTP keep-alive

# Frontend: Public-facing entry point
frontend http_front
    bind *:8088
    default_backend web_servers

# Backend: Set of web servers
backend web_servers
    # Use round-robin load balancing
    # balance roundrobin

    # load balance by url_param, so that a userid with the same value will be forwarded to the same backend server
    # balance url_param userid

    # hdr means header field of the HTTP request
    # balance hdr(User-Agent)

    # always reach to the first server unless the first server reached the max number of connections.
    # balance first

    # depends on the source ip address
    # balance source

    # host with least connection
    balance leastconn

    # check means with health check
    server httpd1 172.10.0.2:80 maxconn 1000 check
    server httpd2 172.10.0.3:80 check
    # Server 2 as backup server, this way, when you test by shutting down the 1st server, 2nd server will be used.
    # server httpd2 172.10.0.3:80 backup

# Optional: Enable HAProxy stats page
listen stats
    bind *:8081                            # Stats page accessible on port 8081
    stats enable
    stats uri /stats                       # Access the stats at /stats
    stats refresh 10s                      # Refresh stats every 10 seconds
    stats admin if LOCALHOST               # Admin access only from localhost
    stats auth admin:password              # Basic auth (username: admin, password: password)
